services:
  mongodb:
    image: mongo:7.0.30
    ports:
      - "${MONGO_HOST_PORT:-27017}:27017"

  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z

  traefik:
    image: traefik:v3.6.9
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=kowloon-network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--ping=true"
      - "--providers.file.directory=/traefik-config"
      - "--providers.file.watch=true"

  kowloon-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kowloon-dev
    restart: unless-stopped
    env_file:
      - .wsl2/env/.env.dev
    environment:
      NODE_ENV: development
      PORT: 3000
      DOMAIN: ${DEV_DOMAIN:-kowloon.localhost}
      MONGO_URI: mongodb://${MONGO_USERNAME:-kowloon}:${MONGO_PASSWORD:-kowloon_password}@mongodb:27017/${MONGO_DATABASE:-kowloon_dev}?authSource=admin
      S3_ENDPOINT: http://minio:9000
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-kowloon}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_PUBLIC_URL: ${S3_PUBLIC_URL:-http://localhost:9000/kowloon}
    depends_on:
      mongodb:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - kowloon-network
    ports:
      - "3000:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.kowloon-dev.loadbalancer.server.port=3000"
      - "traefik.http.routers.kowloon-dev.rule=Host(`${DEV_DOMAIN:-kowloon.localhost}`)"
      - "traefik.http.routers.kowloon-dev.entrypoints=web"
      - "traefik.http.routers.kowloon-dev.service=kowloon-dev"
      - "traefik.http.routers.kowloon-dev-secure.rule=Host(`${DEV_DOMAIN:-kowloon.localhost}`)"
      - "traefik.http.routers.kowloon-dev-secure.entrypoints=websecure"
      - "traefik.http.routers.kowloon-dev-secure.tls=true"
      - "traefik.http.routers.kowloon-dev-secure.service=kowloon-dev"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/__health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
